package uk.frequency.glance.server.business;

import java.util.List;

import org.hibernate.ObjectNotFoundException;

import uk.frequency.glance.server.data_access.EventDAL;
import uk.frequency.glance.server.data_access.UserDAL;
import uk.frequency.glance.server.model.Event;
import uk.frequency.glance.server.model.Location;
import uk.frequency.glance.server.model.Media;
import uk.frequency.glance.server.model.Media.MediaType;
import uk.frequency.glance.server.model.User;
import uk.frequency.glance.server.util.GoogleAPIs;

public class EventBL extends GenericBL<Event>{

	EventDAL eventDal;
	UserDAL userDal;

	public EventBL() {
		super(new EventDAL());
		eventDal = (EventDAL)dal;
		userDal = new UserDAL();
	}
	
	public List<Event> findByAuthor(long userId) throws ObjectNotFoundException {

		User user = userDal.findById(userId);
		user.getId(); //make hibernate do the actual select so it can throw ObjectNotFound. TODO understand why hibernate doesn't throw the exception without this, find appropriate way to accomplish this. 
		
		List<Event> list = eventDal.findByAuthor(userId);
		return list;
	}
	
	public long generateEvent(Location location, long userId){
		String imageUrl = GoogleAPIs.getStreetViewImageUrl(location.getLat(), location.getLng()); //TODO get more from google places and also streetview with different headings, choose best image somehow
		String address = GoogleAPIs.getLocationName(location.getLat(), location.getLng());
		String description = null; //TODO get from google places
		String text = "auto generated"; //TODO

		location.setAddress(address);
		location.setName(description);
		MediaType mediaType = MediaType.IMAGE;
		Media media = new Media();
		media.setType(mediaType);
		media.setUrl(imageUrl);
		User user = new User();
		user.setId(userId);
		Event event = newEntity();
		event.setAutoGenerated(true);
		event.setAuthor(user);
		event.setLocation(location);
		event.setMediaType(mediaType);
		event.setMedia(media);
		event.setText(text);
		
		makePersistent(event);
		
		return event.getId();
	}
	
}
